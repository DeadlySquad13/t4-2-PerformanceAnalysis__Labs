# %% [markdown]
# # –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ñ–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ä–∞—Å—á–µ—Ç–∞–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø–æ–¥—Å–∏—Å—Ç–µ–º –ö–ò–° –≤ –≤–∏–¥–µ —Ä–∞–∑–æ–º–∫–Ω—É—Ç—ã—Ö –∏–ª–∏ –∑–∞–º–∫–Ω—É—Ç—ã—Ö —Å—Ç–æ—Ö–∞—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π
# ## –ó–∞–¥–∞–Ω–∏–µ 1

# –î–ª—è –æ–¥–Ω–æ–∫–∞–Ω–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –Ω–∞ –¥–ª–∏–Ω—É
# –æ—á–µ—Ä–µ–¥–∏ $m$ —Å–æ—Å—Ç–∞–≤—å—Ç–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–ª—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è
# –≤ –∑–∞–¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏. –ù–∞–π–¥–∏—Ç–µ —ç—Ç–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏
# –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–º –∑–Ω–∞—á–µ–Ω–∏–∏ $t$, –∞ —Ç–∞–∫–∂–µ –ø—Ä–∏ $t
# \xrightarrow{} \infty$. –ö–∞–Ω–∞–ª –∏–Ω–æ–≥–¥–∞ –º–æ–∂–µ—Ç –≤—ã—Ö–æ–¥–∏—Ç—å –∏–∑ —Å—Ç—Ä–æ—è. –ó–∞—è–≤–∫–∞, –∫–æ—Ç–æ—Ä–∞—è
# –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫–∞–∑–∞ –∫–∞–Ω–∞–ª–∞ —Å—Ç–∞–≤–∏—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å –º–µ—Å—Ç–∞,
# –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –æ–Ω–∞ –ø–æ–∫–∏–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –Ω–µ–æ–±—Å–ª—É–∂–µ–Ω–Ω–æ–π. –í—Ö–æ–¥—è—â–∏–π –ø–æ—Ç–æ–∫, –ø–æ—Ç–æ–∫
# –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è, –ø–æ—Ç–æ–∫ –æ—Ç–∫–∞–∑–æ–≤ –∏ –ø–æ—Ç–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–µ–π—à–∏–µ
# —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—è–º–∏ $\lambda, \mu, \nu, \gamma$. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
# –∫–ª–∏–µ–Ω—Ç–æ–≤, –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–≥—É—Ç –ø–æ—Å—Ç—É–ø–∞—Ç—å –∑–∞—è–≤–∫–∏ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ $k$. –ù–∞—á–∞–ª—å–Ω—ã–µ
# —É—Å–ª–æ–≤–∏—è $P_0(0) = 1$.

# %%
Variant <- 5
set.seed(Variant)
m <- sample(c(4:18), 1)

mu <- runif(1)

lambda <- runif(1)
if (lambda > mu) {
    current <- lambda
    lambda <- mu
    mu <- current
}

gamma <- runif(1)

nu <- runif(1)

if (gamma < nu) {
    current <- nu
    nu <- gamma
    gamma <- current
}

if (sample(c(0:1), 1)) {
    k <- sample(c(4:7), 1)
} else {
    k <- "inf"
}
t <- runif(1)
View(data.frame(lambda, mu, nu, gamma, k, m, t))

# %% [markdown]
# –í–≤–µ–¥–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
# - $S_0$ - –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω—è–µ–º—ã—Ö –∑–∞–¥–∞—á, –°–ú–û –≥–æ—Ç–æ–≤–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∑–∞–¥–∞—á–∏;
# - $S_1$ - –°–ú–û –∑–∞–Ω—è—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –≤–Ω–µ—à–Ω–µ–π –∑–∞–¥–∞—á–∏, –æ—á–µ—Ä–µ–¥–∏ –Ω–µ—Ç;
# - $S_2$ - –°–ú–û –∑–∞–Ω—è—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –≤–Ω–µ—à–Ω–µ–π –∑–∞–¥–∞—á–∏, –≤ –æ—á–µ—Ä–µ–¥–∏ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞;
# - ...
# - $S_m$ - –°–ú–û –∑–∞–Ω—è—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –≤–Ω–µ—à–Ω–µ–π –∑–∞–¥–∞—á–∏, –≤ –æ—á–µ—Ä–µ–¥–∏ $m$ –∑–∞–¥–∞—á;
# - $S_{m+1}$ - –°–ú–û –≤—ã—à–ª–∞ –∏–∑ —Å—Ç—Ä–æ—è, –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ—Ç –∑–∞–¥–∞—á;
# - $S_{m+2}$ - –°–ú–û –≤—ã—à–ª–∞ –∏–∑ —Å—Ç—Ä–æ—è, –≤ –æ—á–µ—Ä–µ–¥–∏ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞;
# - ...
# - $S_{2m}$ - –°–ú–û –≤—ã—à–ª–∞ –∏–∑ —Å—Ç—Ä–æ—è, –≤ –æ—á–µ—Ä–µ–¥–∏ m –∑–∞–¥–∞—á.

# %% [markdown]
# –¢–æ–≥–¥–∞ –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å:
# ![graph](./State_graph.png)
# –í –±–∏—Ä—é–∑–æ–≤–æ–º –∫–ª–∞—Å—Ç–µ—Ä–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∫–æ–≥–¥–∞ –°–ú–û –≤ —Ä–∞–±–æ—á–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
# –í –∑–µ–ª–µ–Ω–æ–º - –∫–æ–≥–¥–∞ –≤—ã—à–ª–∞ –∏–∑ —Å—Ç—Ä–æ—è.

# %% [markdown]
# ### –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏

# %% [markdown]
# –ü–æ –≥—Ä–∞—Ñ—É —Å–æ—Å—Ç–∞–≤–∏–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞:
# $$
# \begin{cases}
# \frac{dP_0(t)}{dt} = -(\lambda + \nu)P_0(t) + \mu\cdot P_1(t) + \gamma \cdot P_6(t) \\
# \frac{dP_1(t)}{dt} = -(\lambda + \nu + \mu)P_1(t) + \lambda \cdot P_0(t) + \mu \cdot P_2(t) + \gamma \cdot P_7(t) \\
# \frac{dP_2(t)}{dt} = -(\lambda + \nu + \mu)P_2(t) + \lambda \cdot P_1(t) + \mu \cdot P_3(t) + \gamma \cdot P_8(t) \\
# \frac{dP_3(t)}{dt} = -(\lambda + \nu + \mu)P_3(t) + \lambda \cdot P_2(t) + \mu \cdot P_4(t) + \gamma \cdot P_9(t) \\
# \frac{dP_4(t)}{dt} = -(\lambda + \nu + \mu)P_4(t) + \lambda \cdot P_3(t) + \mu \cdot P_5(t) + \gamma \cdot P_{10}(t) \\
# \frac{dP_5(t)}{dt} = -(\nu + \mu)P_5(t) + \lambda \cdot P_4(t) \\
# \frac{dP_6(t)}{dt}  = -(\gamma + \lambda)P_6(t) + \nu \cdot P_0(t) \\
# \frac{dP_7(t)}{dt}  = -(\gamma + \lambda)P_7(t) + \lambda \cdot P_6(t) + \nu \cdot P_1(t) \\
# \frac{dP_8(t)}{dt}  = -(\gamma + \lambda)P_8(t) + \lambda \cdot P_7(t) + \nu \cdot P_2(t) \\
# \frac{dP_9(t)}{dt}  = -(\gamma + \lambda)P_9(t) + \lambda \cdot P_{8}(t) + \nu \cdot P_3(t) \\
# \frac{dP_{10}(t)}{dt} = -\gamma \cdot P_{10}(t) + \lambda \cdot P_{9}(t) + \nu \cdot P_4(t) + \nu \cdot P_5(t)
# \end{cases}
# $$

# –∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏:
# $$
# P_0(t) + P_1(t) + P_2(t) + P_3(t) + P_4(t) + P_5(t) + P_6(t) + P_7(t) + P_8(t) + P_9(t) + P_{10}(t) = 1
# $$

# %% [markdown]
# –†–µ—à–∏–º —ç—Ç–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –ø–∞–∫–µ—Ç–∞ deSolve
# (—Å–º. 75 —Å—Ç—Ä. [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](chrome-extension://gfbliohnnapiefjpjlpjnehglfpaknnc/pages/pdf_viewer.html?r=https://cran.r-project.org/web/packages/deSolve/deSolve.pdf)):

# %%
if (!require("deSolve")) {
    install.packages("deSolve")
}
library(deSolve)

ode_system_equations <- function(Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        dP_0 <- -(lambda + nu) * abs(P_0) + mu * abs(P_1) + gamma * abs(P_6)
        dP_1 <- -(lambda + nu + mu) * abs(P_1) + lambda * abs(P_0) + mu * abs(P_2) + gamma * abs(P_7)
        dP_2 <- -(lambda + nu + mu) * abs(P_2) + lambda * abs(P_1) + mu * abs(P_3) + gamma * abs(P_8)
        dP_3 <- -(lambda + nu + mu) * abs(P_3) + lambda * abs(P_2) + mu * abs(P_4) + gamma * abs(P_9)
        dP_4 <- -(lambda + nu + mu) * abs(P_4) + lambda * abs(P_3) + mu * abs(P_5) + gamma * abs(P_10)
        dP_5 <- -(nu + mu) * abs(P_5) + lambda * abs(P_4)
        dP_6 <- -(gamma + lambda) * abs(P_6) + nu * abs(P_0)
        dP_7 <- -(gamma + lambda) * abs(P_7) + lambda * abs(P_6) + nu * abs(P_1)
        dP_8 <- -(gamma + lambda) * abs(P_8) + lambda * abs(P_7) + nu * abs(P_2)
        dP_9 <- -(gamma + lambda) * abs(P_9) + lambda * abs(P_8) + nu * abs(P_3)
        dP_10 <- -gamma * abs(P_10) + lambda * abs(P_9) + nu * abs(P_4) + nu * abs(P_5)
        norm <- P_0 + P_1 + P_2 + P_3 + P_4 + P_5 + P_6 + P_7 + P_8 + P_9 + P_10

        # Specifying list of derivatives.
        return(
            list(c(
                dP_0,
                dP_1,
                dP_2,
                dP_3,
                dP_4,
                dP_5,
                dP_6,
                dP_7,
                dP_8,
                dP_9,
                dP_10,
                norm
            ))
        )
    })
}

# %% [markdown]
# –£—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏ –≤ –¥–∞–Ω–Ω–æ–º –ø–∞–∫–µ—Ç–µ –∑–∞–¥–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –Ω–µ–ª—å–∑—è, –æ–Ω–æ –±—É–¥–µ—Ç
# –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è –∫–∞–∫ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ. –û–¥–Ω–∞–∫–æ –µ—Å–ª–∏ –µ–≥–æ —É–ø—É—Å—Ç–∏—Ç—å,
# –∑–Ω–∞—á–µ–Ω–∏—è $P_i$ –±—É–¥—É—Ç –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã $[0, 1]$.

# –¢–∞–∫–∂–µ, –µ—Å–ª–∏ –µ–≥–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏ –∑–∞–¥–∞—Ç—å –≤ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö —Ä–∞–≤–Ω—ã–º 1, –æ–Ω–æ –≤—Å–µ
# —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—Ç–∏ –¥–æ $\infty$, –¥–µ—Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É—è –ø—Ä–∏ —ç—Ç–æ–º $P_i$ (
# –æ–Ω–∏ —Ç–æ–∂–µ –±—É–¥—É—Ç –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–µ –ø—Ä–µ–¥–µ–ª—ã).
#
# –ü–æ—ç—Ç–æ–º—É –±—ã–ª–æ –ø—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ—Å—Ç–∞–≤–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏ –∫–∞–∫
# –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ, –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Å—å –ø—Ä–∏ —ç—Ç–æ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
# `events`, –ø–æ–∑–≤–æ–ª—è—é—â–∏–º –∑–∞–¥–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ —á–∞—Å—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
# –≤—Ä–µ–º–µ–Ω–∏. –¢–∞–∫, "–æ–±–Ω—É–ª—è—è" –∑–Ω–∞—á–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏ –¥–æ 1 –∫–∞–∂–¥—ã–µ 10 —Ç–∞–∫—Ç–æ–≤,
# –º—ã —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –û–î–£: –ø–æ —Ç–∞–±–ª–∏—Ü–µ `output`
# –≤–∏–¥–Ω–æ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `norm` —á–∞—Å—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—ã—à–µ 1, –æ–¥–Ω–∞–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è
# $P_i$ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ $[0, 1]$ –∏ –∏—Ö —Å—É–º–º–∞ —Ä–∞–≤–Ω–∞ 1. –ò–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ
# –º—ã –∏ –¥–æ–±–∏–≤–∞–ª–∏—Å—å.

# %%
pars <- NULL
yini <- c(
    P_0 = 1,
    P_1 = 0,
    P_2 = 0,
    P_3 = 0,
    P_4 = 0,
    P_5 = 0,
    P_6 = 0,
    P_7 = 0,
    P_8 = 0,
    P_9 = 0,
    P_10 = 0,
    norm = 1
)


INITIAL_TIME <- 0
FINISH_TIME <- 100000

norm_equation_values <- data.frame(
    var = "norm",
    time = INITIAL_TIME:FINISH_TIME,
    value = 1,
    method = "replace"
)

ACCURACY <- 0.1
times <- seq(INITIAL_TIME, FINISH_TIME, by = ACCURACY)
output <- ode(yini, times, ode_system_equations, pars, events = list(data = norm_equation_values))
output

# %% [markdown]
# –í—ã—á–∏—Å–ª–∏–º –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –≤–∑—è—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–∏
# –∑–∞–¥–∞–Ω–æ–º –≤ —É—Å–ª–æ–≤–∏–∏ $t$:

# %%
PRECISION_OF_ACCURACY <- 1
t_index <- round(t, PRECISION_OF_ACCURACY) * 10^PRECISION_OF_ACCURACY + 1
t_index

# %% [markdown]
# –ü–æ –¥–∞–Ω–Ω–æ–º—É –∏–Ω–¥–µ–∫—Å—É –∏–º–µ–µ–º –±–ª–∏–∂–∞–π—à–∏–π –≤–µ–∫—Ç–æ—Ä –∑–Ω–∞—á–µ–Ω–∏–π:

# %%
results <- output[t_index, 1:12]
results

# %% [markdown]
# –ü—Ä–∏ $t \rightarrow{} \infty$ (–≤–∑—è–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è $t$
# –≤—ã—à–µ –Ω–µ—Ç —Å–º—ã—Å–ª–∞, —Ç–∞–∫ –∫–∞–∫ –≤–∏–¥–Ω–æ, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è $\forall P_i$ –≤ –∫–æ–Ω—Ü–µ —Ç–∞–±–ª–∏—Ü—ã
# —Å—Ö–æ–¥—è—Ç—Å—è):

# %%
results <- output[nrow(output), 2:12]
results

# %% [markdown]
# –ü–æ–¥—Ç–≤–µ—Ä–¥–∏–º, —á—Ç–æ $\sum P_i = 1$:
# %%
sum(results)

# %%
get_P <- function(P_index) {
    return(as.numeric(results)[1 + P_index])
}

# %% [markdown]
# #### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è
# –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è —Ä–∞–≤–Ω–∞ $P_0$:

# %%
get_P(0)

# %% [markdown]
# #### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
# –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ $P_{\text{–æ—á}}$ —Ä–∞–≤–Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ $P_{\overline{\text{–æ—á}}}$.
# –¢–∞, –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å, —Ä–∞–≤–Ω–∞ —Å—É–º–º–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è–º,
# –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞.
# $$
# P_{\text{–æ—á}} = 1 - P_{\overline{\text{–æ—á}}} = 1 - (P_0 + P_1 + P_{m + 1})
# $$

# %%
1 - (get_P(0) + get_P(1) + get_P(m + 1))

# %% [markdown]
# #### –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
#  –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–∏–º –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
# $$
# \lambda'=\lambda\cdot(1-P_m(t)-P_{2m}(t))
# $$

# %%
absolute_flow_capacity <- lambda * (1 - get_P(m) - get_P(2 * m))
absolute_flow_capacity

# %% [markdown]
# #### –°—Ä–µ–¥–Ω—é—é –¥–ª–∏–Ω—É –æ—á–µ—Ä–µ–¥–∏
# –î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–æ—Å—É–º–º–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
# –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç—Ç–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º –¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–µ–π.
# $$
# L_{\text{–æ—á}} = 1 \cdot P_2(t) + 2 \cdot P_3(t) + 3 \cdot P_4(t) +
# \text{...} + (m-1) \cdot P_m + 1 \cdot P_{m+2}(t) + 2 \cdot P_{m+3}(t) +
# \text{...} + (m - 1) \cdot P_{2m}(t)
# $$

# %%
# –ü–æ–ª—É—á–∞–µ–º –¥–ª–∏–Ω—É –æ—á–µ—Ä–µ–¥–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏.
P.get_queue_length <- function(P_index) {
    if (P_index < 1) {
        return(0)
    }

    if (P_index <= m) {
        return(P_index - 1)
    }

    return(P_index - m - 1)
}

P.get_product <- function(P_index) {
    return(get_P(P_index) * P.get_queue_length(P_index))
}

mean_length <- sum(unlist(
    lapply(c(2:m), P.get_product)
)) + sum(unlist(
    lapply(c((m + 2):(2 * m)), P.get_product)
))
mean_length

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
# $$
# W_{\text{–æ—á}}=\frac{L_{\text{–æ—á}}}{\lambda'}
# $$

# %%
W <- mean_length / absolute_flow_capacity
W

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# –î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–æ—Å—É–º–º–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
# –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç—Ç–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# (–¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–µ–π + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏):
# $$
# L = (1 + 0) \cdot P_1(t) + (1 + 1) \cdot P_2(t) + (1 + 2) \cdot P_3(t) +
# (1 + 3) \cdot P_4(t) + \text{...} + (1 + m - 1) \cdot P_m +
# 1 \cdot P_{m+2}(t) + 2 \cdot P_{m+3}(t) + \text{...} + (m - 1) \cdot P_{2m}(t)
# $$

# %%
# –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏.
P.get_number_of_requests_proccessed <- function(P_index) {
    if (P_index > 0 && P_index <= m) {
        return(1)
    }

    return(0)
}

P.get_product1 <- function(P_index) {
    P.number_of_requests <- P.get_queue_length(P_index) + P.get_number_of_requests_proccessed(P_index)

    return(get_P(P_index) * P.number_of_requests)
}

mean_number_of_requests <- sum(unlist(
    lapply(c(2:m), P.get_product1)
)) + sum(unlist(
    lapply(c((m + 2):(2 * m)), P.get_product1)
))
mean_number_of_requests

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# $$
# T =\frac{L}{\lambda'}
# $$

# %%
T <- mean_number_of_requests / absolute_flow_capacity
T

# %% [markdown]
# ### –ß–∏—Å–ª–µ–Ω–Ω–æ
# –ü–æ—Å—Ç—Ä–æ–∏–º —Å –ø–æ–º–æ—â—å—é –ø–∞–∫–µ—Ç–∞ simmer —Å–∏–º—É–ª—è—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã $M/M/1/m$.


# %%
if (!require("simmer")) {
    install.packages("simmer")
}
library(simmer)
if (!require("simmer.plot")) {
    install.packages("simmer.plot")
}
library(simmer.plot)

MM1m.env <- simmer("SuperDuperSim")
MM1m.env

# %% [markdown]
–ó–∞–¥–∞–¥–∏–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –æ—Ç–∫–∞–∑–∞ –≤ —Å–ª—É—á–∞–µ –ø–æ–ª–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏:

# %%
m.queue <- trajectory("clients' path") %>%
    ## add an intake activity
    seize("server", amount = 1) %>%
    timeout(function() rexp(1, 1 / mu)) %>%
    release("server", amount = 1)

# %% [markdown]
# –î–æ–±–∞–≤–∏–º —Å–∏–º—É–ª—è—Ü–∏—é –ø–æ–ª–æ–º–∫–∏ —Å–∏—Å—Ç–µ–º—ã, –∑–∞–¥–∞–≤ –º–µ—Ö–∞–Ω–∏–∑–º —Å–º–µ–Ω—ã –ø–æ–ª—è $capacity$ —Ä–µ—Å—É—Ä—Å–∞
# $server$ —Å 1 –Ω–∞ 0 –∏ –æ–±—Ä–∞—Ç–Ω–æ —Å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å—é $\gamma$ –∏ $\nu$ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

# %%
# Transform intervals timetable of chronologic points.
# Example:
# 1, 2, 0.5, 0.3, 0.2 -> 1, 3, 3.5, 3.8, 4
accumulate <- function(intervals) {
    timetable <- c()

    for (interval_index in seq_along(intervals)) {
        point <- intervals[interval_index]

        if (interval_index > 1) {
            point <- point + timetable[interval_index - 1]
        }

        timetable <- append(timetable, point)
    }

    return(timetable)
}

# %%
create_timetable <- function(number_of_points, break_intensity, repair_intensity) {
    intervals <- c()

    for (interval_index in 1:number_of_points) {
        intensity <- break_intensity

        if (interval_index %% 2 == 0) {
            intensity <- repair_intensity
        }

        intervals <- append(intervals, rexp(1, 1 / intensity))
    }


    return(accumulate(intervals))
}

create_capacity_schedule <- function(number_of_points) {
    stopifnot(number_of_points %% 2 == 0)

    timetable <- create_timetable(
        number_of_points,
        break_intensity = gamma,
        repair_intensity = nu
    )

    capacity_sequence <- rep(c(1, 0), times = number_of_points / 2)

    period <- sum(timetable)

    return(
        schedule(
            timetable,
            capacity_sequence,
            period
        )
    )
}

capacity_schedule <- create_capacity_schedule(1000)

# %%
SIMULATION_TIME <- FINISH_TIME

MM1m.env %>%
    add_resource(
        "server",
        capacity = capacity_schedule,
        queue_size = m
    ) %>%
    add_generator("clients", m.queue, function() rexp(1, lambda)) %>%
    run(until = SIMULATION_TIME)

# %%
arrivals <- get_mon_arrivals(MM1m.env)
arrivals

# %% [markdown]
# –õ–æ–≥–∏ —Å–∏–º—É–ª—è—Ü–∏–∏:

# %%
resources <- get_mon_resources(MM1m.env)
resources

# %% [markdown]
# #### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è
# –ü–æ–¥—Å—á–∏—Ç–∞–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞,
# –∫ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ—Å—Ç–æ—è–Ω–∏–π.

# %%
free_states <- resources %>% subset(server == 0) %>% subset( capacity > 0)
free_states

# %%
nrow(free_states) / nrow(resources)

# %% [markdown]
# #### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
# –í—ã—á–∏—Å–ª–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏, –ø–æ–¥—Å—á–∏—Ç–∞–≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π,
# –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ—á–µ—Ä–µ–¥—å –Ω–µ –ø—É—Å—Ç–∞, –∫ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø–∏—Å–µ–π.

# %%
queue_unempty <- resources %>% subset(queue != 0)
queue_unempty

# %%
nrow(queue_unempty) / nrow(resources)

# %% [markdown]
# #### –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
#  –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–∏–º –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
# $$
# \lambda'=\lambda\cdot(1-P_m(t)-P_{2m}(t))
# $$

# %%
number_of_unfinished <- arrivals %>% with(sum(!finished))
number_of_unfinished

# %%
finish_probability <- number_of_unfinished / nrow(arrivals)
finish_probability

# %%
absolute_flow_capacity <- lambda * finish_probability
absolute_flow_capacity

# %% [markdown]
# #### –°—Ä–µ–¥–Ω—é—é –¥–ª–∏–Ω—É –æ—á–µ—Ä–µ–¥–∏

# %%
mean_length <- resources %>% with(mean(queue))
mean_length

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
# –ü–æ—Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ –∏ —Å—Ä–∞–≤–Ω–∏–º –µ–≥–æ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º $W_\text{–æ—á}$ (—á–µ—Ä–Ω–∞—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä—è–º–∞—è), –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏:

# %%
W <- mean_length / absolute_flow_capacity
W

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ —Å—Ä–∞–≤–Ω–∏–º —Å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–º, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—è –≥—Ä–∞—Ñ–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
# —Ä–µ—Å—É—Ä—Å–∞ `server`:

# %% [markdown]
# –†–∞—Å—Å—á–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ,
# –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Å—å —Ç–∞–±–ª–∏—Ü–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:

# %%
mean_number_of_requests <- resources %>% with(mean(server) + mean(system))
mean_number_of_requests

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ $T$
# –ü–æ—Å—Ç—É–ø–∏–º —Å–æ —Å—Ä–µ–¥–Ω–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ $T$ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏
# —Å $W$ - —Å—Ä–∞–≤–Ω–∏–º –¥–≤–∞ –≥—Ä–∞—Ñ–∏–∫–∞:

# %%
T <- mean_number_of_requests / absolute_flow_capacity
T

# %% [markdown]
# ### –í—ã–≤–æ–¥—ã
# –ö–∞–∫ –≤–∏–¥–Ω–æ, —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—é—Ç
# —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —á–∏—Å–ª–µ–Ω–Ω—ã–º –º–µ—Ç–æ–¥–æ–º. –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
# —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ ùëÅ —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.
