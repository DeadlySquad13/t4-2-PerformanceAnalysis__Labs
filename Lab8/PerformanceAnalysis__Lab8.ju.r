# %% [markdown]
# # –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 8. –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–∫–∞–Ω–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∑–∞—è–≤–æ–∫
# –í—ã–ø–æ–ª–Ω–∏–ª —Å—Ç—É–¥–µ–Ω—Ç –†–¢5-81–ë –ü–∞–∫–∞–ª–æ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á

# %% [markdown]
# –ó–∞–¥–∞–Ω–∏–µ 1.
# –°–∏—Å—Ç–µ–º–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º
# –ø–æ—Å—Ç—É–ø–∞—é—â–µ–π –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ü–∏–∏ –¥–æ–ª–∂–Ω–∞ —É—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—É—é –≤–∞–∂–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤,
# –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ $P$,
# —Å—Ä–µ–¥–Ω—è—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∑–∞—è–≤–æ–∫
# $\lambda_1, \lambda_2, \dots, \lambda_P$,
# —Å—Ä–µ–¥–Ω—è—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
# $\mu_1, \mu_2, \dots, \mu_P$ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –æ—á–µ—Ä–µ–¥—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞.
# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞—è–≤–æ–∫
# $p_1 < p_2 < \dots < p_P$.

# –û—Ü–µ–Ω–∏—Ç—å —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞—è–≤–∫–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏
# –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ) –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑ 4 —Å–ª—É—á–∞–µ–≤:

# - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (V1);
# - –∞–±—Å–æ–ª—é—Ç–Ω—ã–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (V2);
# - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å –∑–∞–≤–∏—Å–∏–º–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (V3);
# - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å –∑–∞–≤–∏—Å–∏–º–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π —Å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏ (V4);

# –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–º.
# %%
Variant <- 5
set.seed(Variant)
V <- sample(c("V1", "V2", "V3", "V4"), 1)
P <- sample(c(4, 6), 1)
if ((V == "V3") | (V == "V4")) {
    b <- sort(sample(c(1:10), P))
}
lambda <- runif(P)
mu <- runif(P, 1, 3)
View(data.frame(P, V))
if ((V == "V3") | (V == "V4")) {
    View(data.frame(lambda, mu, b))
}
if ((V == "V1") | (V == "V2")) {
    View(data.frame(lambda, mu))
}

# %%
sum(lambda / mu)

# %% [markdown]
# –ö–∞–∫ –≤–∏–¥–Ω–æ, —Å—É–º–º–∞—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É –ø—Ä–µ–≤—ã—à–∞–µ—Ç 1, —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –±—É–¥–µ—Ç
# –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –æ—á–µ—Ä–µ–¥—å. –ù–µ–º–Ω–æ–≥–æ –∏–∑–º–µ–Ω–∏–º
# –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

# %%
lambda[1] <- 0.1
lambda[2] <- 0.1
ro <- sum(lambda / mu)
ro

# %% [markdown]
# ### –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏
# $$\lambda=\sum_{p=1}^P\lambda_p$$

# %%
lambda_ <- sum(lambda)
lambda_

# %% [markdown]
# $$\frac{1}{\mu}=\sum_{p=1}^P \frac{\lambda_p}{\lambda}\cdot \frac{1}{\mu_p}$$

# %%
ro <- lambda / mu

mu_ <- sum(ro) / lambda_
mu_


# %% [markdown]
# $$\rho=\frac{\lambda}{\mu}$$

# %%
ro_ <- lambda_ / mu_
ro_

# %% [markdown]
# $$W_0=\sum_{p=1}^P\frac{\rho_p}{\mu_p}$$

# %%
W0 <- sum(ro / mu)
W0


# %% [markdown]
# –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è $W_p$ –≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è —Ñ–æ—Ä–º—É–ª–æ–π

# $$W_p= \frac{\frac{\rho_p}{\mu_p}+\sum_{i=p+1}^P \rho_i\cdot \left(\frac{1}{\mu_p}+\frac{1}{\mu_i}\right)+\sum_{i=p+1}^P\rho_i\cdot W_i}{1-\sum_{i=p}^P \rho_i}$$

# %%
get_Wqueue <- function(p) {
    numerator <- ro[p] / mu[p]
    denominator <- 1 - sum(ro[p:P])

    if (p == P) {
        return(numerator / denominator)
    }

    sum_part1 <- sum(unlist(
        lapply(
            c((p + 1):P),
            function(i) ro[i] * (1 / mu[p] + 1 / mu[i])
        )
    ))

    sum_part2 <- sum(unlist(
        lapply(
            c((p + 1):P),
            function(i) ro[i] * get_Wqueue(i)
        )
    ))

    result <- (numerator + sum_part1 + sum_part2) / denominator


    if (result < 0) {
        return(Inf)
    }

    return(result)
}

results <- data.frame(theoretical = unlist(lapply(1:P, get_Wqueue)))
row.names(results) <- 1:P
results

# %% [markdown]
# ### –ß–∏—Å–ª–µ–Ω–Ω–æ

# %%
if (!require("simmer")) {
    install.packages("simmer")
}
library(simmer)

env <- simmer("SuperDuperSim")
env

# %%
create_trajectory <- function(mu, name) {
    return(trajectory(name) %>%
        seize("server", 1) %>%
        timeout(function() rexp(1, mu)) %>%
        release("server", 1))
}

create_application_generator <- function(env, i) {
    name <- gsub(" ", "", paste("documents", i))

    env %>%
        add_generator(
            name_prefix = name,
            trajectory = create_trajectory(mu[i], name),
            distribution = function() rexp(1, lambda[i]),
            priority = i,
            preemptible = i + 1,
        )
}

add_generators <- function(env, n) {
    for (i in 1:n) {
        create_application_generator(env, i)
    }
}

# %%
SIMULATION_TIME <- 10000

env %>%
    add_resource("server", preemptive = TRUE)

add_generators(env, P)

env %>% run(until = SIMULATION_TIME)

# %%
programmers <- trajectory("programmers' path") %>%
    ## add an intake activity
    seize("server", 1) %>%
    timeout(function() rexp(1, 1 / t2)) %>%
    release("server", 1)

# %%
arrivals <- env %>% get_mon_arrivals(ongoing = TRUE) # Show ongoing tasks too.
resources <- env %>% get_mon_resources()
arrivals
resources

# %% [markdown]
# –û—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ–º NA –∑–Ω–∞—á–µ–Ω–∏—è:

# %%
arrivals["end_time"][arrivals["start_time"] == -1] <- SIMULATION_TIME
arrivals["start_time"][arrivals["start_time"] == -1] <- SIMULATION_TIME
arrivals["end_time"][is.na(arrivals["end_time"])] <- SIMULATION_TIME
arrivals["activity_time"][is.na(arrivals["activity_time"])] <- 0

# %% [markdown]
# –†–∞–∑–¥–µ–ª–∏–º –∑–∞—è–≤–∫–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –∏ –ø–æ–¥—Å—á–∏—Ç–∞–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º—è:

# %%
patterns <- lapply(1:P, function(i) paste("documents", i, sep = ""))

results$practical <- lapply(patterns, function(pattern) {
    arrivals[grepl(arrivals$name, pattern = pattern, fixed = TRUE), ] %>%
        with(mean(end_time - activity_time - start_time))
})
patterns
results

# %% [markdown]
# ### –í—ã–≤–æ–¥
# –ö–∞–∫ –≤–∏–¥–Ω–æ, —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—é—Ç
# —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
# —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ ùëÅ —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.
