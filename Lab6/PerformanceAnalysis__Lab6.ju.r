# %% [markdown]
# # –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6. –ú–µ—Ç–æ–¥ –∫–≤–∞–∑–∏—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ–≥–æ —É–∫—Ä—É–ø–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–Ω–æ–≥–æ–º–µ—Ä–Ω—ã—Ö –º–∞—Ä–∫–æ–≤—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è-–≥–∏–±–µ–ª–∏
# ## –ó–∞–¥–∞–Ω–∏–µ 1

# $K$ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ $M$ —Å–µ—Ä–≤–µ—Ä–æ–≤,
# –ø—Ä–∏ —ç—Ç–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç —Å—Ä–∞–∑—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä,
# –∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ $N$ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤,
# –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∏—Ä—É—Å–æ–≤.
# –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤ $\lambda$,
# –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤-–∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤ $\nu$,
# –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ $\mu$,
# –ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å –≤–∏—Ä—É—Å–æ–º —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é $p$.
# –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –≤–∏—Ä—É—Å–æ–º, –æ–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–∫–∞–∑ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö
# —Å–µ—Ä–≤–µ—Ä–∞—Ö. –î–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤–∏—Ä—É—Å–æ–≤ –∏–º–µ–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ
# –æ—á–µ—Ä–µ–¥–∏ $m_1$ , –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ –æ—á–µ—Ä–µ–¥–∏ $m_2$.

# - –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å–∏—Å—Ç–µ–º—ã, —É—á–∏—Ç—ã–≤–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤,
# –∫–æ—Ç–æ—Ä—ã–µ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö-–∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞—Ö,
# –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö;
# - –ù–∞–ø–∏—Å–∞—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞ –¥–ª—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π —Å–æ—Å—Ç–æ—è–Ω–∏–π, —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö
# –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π;
# - –¢—Ä–µ–º—è —Å–ø–æ—Å–æ–±–∞–º–∏ (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ, –º–µ—Ç–æ–¥–æ–º —É–∫—Ä—É–ø–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π, –ø–æ
# —É—Ä–∞–≤–Ω–µ–Ω–∏—è–º –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞) –Ω–∞–π—Ç–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –°–ú–û:
# —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ, –∞–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å,
# —Å—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ.

# %%
Variant<-5
set.seed(Variant) 
K<-sample(c(3:6),1)
M<-sample(c(1:3),1)
N<-sample(c(1:3),1)
lambda<-runif(1)
mu<-runif(1)
nu<-runif(1)
p<-runif(1)
m2<-sample(c(0:2),1)
m1<-sample(c(0:2),1)
View(data.frame(K,M,N,lambda,mu,nu,p,m1,m2))

# %% [markdown]
# –í–≤–µ–¥–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
# - $S_{4000}$ - –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã
# —Å–≤–æ–±–æ–¥–Ω—ã;
# - $S_{3010}$ - —Ç—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# –≤–∏—Ä—É—Å;
# - $S_{3001}$ - —Ç—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
# –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{2110}$ - –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# - $S_{2110}$ - –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# –≤–∏—Ä—É—Å, –æ–¥–Ω–∞ —Å—Ç–æ–∏—Ç –≤ –æ—á–µ—Ä–µ–¥–∏;
# - $S_{2011}$ - –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# –≤–∏—Ä—É—Å, –æ–¥–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{2002}$ - –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –¥–≤–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{1111}$ - –æ–¥–∏–Ω –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –ø–∏—à–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å—Ç–æ–∏—Ç
# –≤ –æ—á–µ—Ä–µ–¥–∏, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –≤–∏—Ä—É—Å, –¥–≤–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{1003}$ - –æ–¥–∏–Ω –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –ø–∏—à–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, —Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞
# - $S_{1012}$ - –æ–¥–∏–Ω –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –ø–∏—à–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
# –Ω–∞ –≤–∏—Ä—É—Å, –¥–≤–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{1003}$ - –æ–¥–∏–Ω –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –ø–∏—à–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, —Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞
# —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{0112}$ - –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –æ–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å—Ç–æ–∏—Ç
# –≤ –æ—á–µ—Ä–µ–¥–∏, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
# –Ω–∞ –≤–∏—Ä—É—Å, –¥–≤–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{0013}$ - –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –æ–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# –≤–∏—Ä—É—Å, —Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;


# %% [markdown]
# –¢–æ–≥–¥–∞ –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å:
# ![graph](./State_graph.png)

# %% [markdown]
# ### –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –ø–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è–º –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞

# %% [markdown]
# –ü–æ –≥—Ä–∞—Ñ—É —Å–æ—Å—Ç–∞–≤–∏–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞:
# $$
# \begin{cases}
# \frac{dP_{4000}(t)}{dt} = -4 \lambda P_{4000}(t) + p \nu P_{3010}(t) + \mu P_{3001}(t) \\
# \frac{dP_{3010}(t)}{dt} = -(3 \lambda + p\nu + (1-p)\nu) P_{3010}(t) + 4 \lambda P_{4000}(t) + p \nu P_{2110}(t) + \mu P_{2011}(t) \\
# \frac{dP_{2110}(t)}{dt} = -(p\nu + (1-p)\nu) P_{2110}(t) + 3 \lambda P_{3010}(t) + \mu P_{1111} \\
# \frac{dP_{3001}(t)}{dt} = -(3 \lambda + \mu) P_{3001}(t) + p \nu P_{2011} + 2 \mu P_{2002} + (1-p) \nu P_{3010}(t) \\
# \frac{dP_{2011}(t)}{dt} = -(2 \lambda + p\nu + (1-p)\nu + \mu) P_{2011}(t) + 3 \lambda P_{3001}(t) + p \nu P_{1111}(t) + 2 \mu P_{1012}(t) + (1-p)\nu P_{2110}(t) \\
# \frac{dP_{1111}(t)}{dt} = -(p\nu + (1-p)\nu + \mu) P_{1111}(t) + 2 \lambda P_{2011}(t) + 2 \mu P_{0112} \\
# \frac{dP_{2002}(t)}{dt} = -(2 \lambda + 2 \mu) P_{2002}(t) + p \nu P_{1012} + 3 \mu P_{1003} + (1-p) \nu P_{2011}(t) \\
# \frac{dP_{1012}(t)}{dt} = -(\lambda + p\nu + (1-p)\nu + 2 \mu) P_{1012}(t) + 2 \lambda P_{2002}(t) + p \nu P_{0112}(t) + 3 \mu P_{0013}(t) + (1-p)\nu P_{1111}(t) \\
# \frac{dP_{0112}(t)}{dt} = -(p\nu + (1-p)\nu + 2 \mu) P_{0112}(t) + \lambda P_{1012}(t) \\
# \frac{dP_{1003}(t)}{dt} = -(\lambda + 3 \mu) P_{1003}(t) + p\nu P_{0013}(t) + (1-p)\nu P_{1012}(t) \\
# \frac{dP_{0013}(t)}{dt} = -(p\nu + 3 \mu) P_{0013}(t) + \lambda P_{1003}(t) + (1-p)\nu P_{0112}(t)
# \end{cases}
# $$

# –∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏:
# $$
# P_{4000}(t) + P_{3010}(t) + P_{2110}(t) + P_{3001}(t) + P_{2011}(t) + P_{1111}(t) + P_{2002}(t) + P_{1012}(t) + P_{0112}(t) + P_{1003}(t) + P_{0013}(t) = 1
# $$

# %% [markdown]
# –†–µ—à–∏–º —ç—Ç–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –ø–∞–∫–µ—Ç–∞ deSolve
# (—Å–º. 75 —Å—Ç—Ä. [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](chrome-extension://gfbliohnnapiefjpjlpjnehglfpaknnc/pages/pdf_viewer.html?r=https://cran.r-project.org/web/packages/deSolve/deSolve.pdf)):

# %%
if (!require("deSolve")) {
    install.packages("deSolve")
}
library(deSolve)

ode_system_equations <- function(Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        dP_4000 <- -4 * lambda * abs(P_4000) + p * nu * abs(P_3010) + mu * abs(P_3001)
        dP_3010 <- -(3 * lambda + p * nu + (1-p) * nu) * abs(P_3010) + 4 * lambda * abs(P_4000) + p * nu * abs(P_2110) + mu * abs(P_2011)
        dP_2110 <- -(p * nu + (1-p) * nu) * abs(P_2110) + 3 * lambda * abs(P_3010) + mu * abs(P_1111)
        dP_3001 <- -(3 * lambda + mu) * abs(P_3001) + p * nu * abs(P_2011) + 2 * mu * abs(P_2002) + (1-p) * nu * abs(P_3010)
        dP_2011 <- -(2 * lambda + p* nu + (1-p) * nu + mu) * abs(P_2011) + 3 * lambda * abs(P_3001) + p * nu * abs(P_1111) + 2 * mu * abs(P_1012) + (1-p) * nu * abs(P_2110)
        dP_1111 <- -(p * nu + (1-p) * nu + mu) * abs(P_1111) + 2 * lambda * abs(P_2011) + 2 * mu * abs(P_0112)
        dP_2002 <- -(2 * lambda + 2 * mu) * abs(P_2002) + p * nu * abs(P_1012) + 3 * mu * abs(P_1003) + (1-p) * nu * abs(P_2011)
        dP_1012 <- -(lambda + p * nu + (1-p) * nu + 2 * mu) * abs(P_1012) + 2 * lambda * abs(P_2002) + p * nu * abs(P_0112) + 3 * mu * abs(P_0013) + (1-p) * nu * abs(P_1111)
        dP_0112 <- -(p * nu + (1-p) * nu + 2 * mu) * abs(P_0112) + lambda * abs(P_1012)
        dP_1003 <- -(lambda + 3 * mu) * abs(P_1003) + p * nu * abs(P_0013) + (1-p) * nu * abs(P_1012)
        dP_0013 <- -(p * nu + 3 * mu) * abs(P_0013) + lambda * abs(P_1003) + (1-p) * nu * abs(P_0112)
        norm <- abs(P_4000) + abs(P_3010) + abs(P_2110) + abs(P_3001) + abs(P_2011) + abs(P_1111) + abs(P_2002) + abs(P_1012) + abs(P_0112) + abs(P_1003) + abs(P_0013)

        # Specifying list of derivatives.
        return(
            list(c(
                dP_4000,
                dP_3010,
                dP_2110,
                dP_3001,
                dP_2011,
                dP_1111,
                dP_2002,
                dP_1012,
                dP_0112,
                dP_1003,
                dP_0013,
                norm
            ))
        )
    })
}

# %% [markdown]
# –£—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏ –≤ –¥–∞–Ω–Ω–æ–º –ø–∞–∫–µ—Ç–µ –∑–∞–¥–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –Ω–µ–ª—å–∑—è, –æ–Ω–æ –±—É–¥–µ—Ç
# –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è –∫–∞–∫ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ. –û–¥–Ω–∞–∫–æ –µ—Å–ª–∏ –µ–≥–æ —É–ø—É—Å—Ç–∏—Ç—å,
# –∑–Ω–∞—á–µ–Ω–∏—è $P_i$ –±—É–¥—É—Ç –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã $[0, 1]$.

# –¢–∞–∫–∂–µ, –µ—Å–ª–∏ –µ–≥–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏ –∑–∞–¥–∞—Ç—å –≤ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö —Ä–∞–≤–Ω—ã–º 1, –æ–Ω–æ –≤—Å–µ
# —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—Ç–∏ –¥–æ $\infty$, –¥–µ—Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É—è –ø—Ä–∏ —ç—Ç–æ–º $P_i$ (
# –æ–Ω–∏ —Ç–æ–∂–µ –±—É–¥—É—Ç –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–µ –ø—Ä–µ–¥–µ–ª—ã).
#
# –ü–æ—ç—Ç–æ–º—É –±—ã–ª–æ –ø—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ—Å—Ç–∞–≤–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏ –∫–∞–∫
# –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ, –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Å—å –ø—Ä–∏ —ç—Ç–æ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
# `events`, –ø–æ–∑–≤–æ–ª—è—é—â–∏–º –∑–∞–¥–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–µ —á–∞—Å—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
# –≤—Ä–µ–º–µ–Ω–∏. –¢–∞–∫, "–æ–±–Ω—É–ª—è—è" –∑–Ω–∞—á–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏ –¥–æ 1 –∫–∞–∂–¥—ã–µ 10 —Ç–∞–∫—Ç–æ–≤,
# –º—ã —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –û–î–£: –ø–æ —Ç–∞–±–ª–∏—Ü–µ `output`
# –≤–∏–¥–Ω–æ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `norm` —á–∞—Å—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—ã—à–µ 1, –æ–¥–Ω–∞–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è
# $P_i$ –≤—Å–µ —Ä–∞–≤–Ω–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ $[0, 1]$ –∏ –∏—Ö —Å—É–º–º–∞ —Ä–∞–≤–Ω–∞ 1. –ò–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ
# –º—ã –∏ –¥–æ–±–∏–≤–∞–ª–∏—Å—å.

# %%
pars <- NULL
yini <- c(
    P_4000 = 1,
    P_3010 = 0,
    P_2110 = 0,
    P_3001 = 0,
    P_2011 = 0,
    P_1111 = 0,
    P_2002 = 0,
    P_1012 = 0,
    P_0112 = 0,
    P_1003 = 0,
    P_0013 = 0,
    norm = 1
)


INITIAL_TIME <- 0
FINISH_TIME <- 100000

norm_equation_values <- data.frame(
    var = "norm",
    time = INITIAL_TIME:FINISH_TIME,
    value = 1,
    method = "replace"
)

ACCURACY <- 0.1
times <- seq(INITIAL_TIME, FINISH_TIME, by = ACCURACY)
output <- ode(yini, times, ode_system_equations, pars, events = list(data = norm_equation_values))
output

# %% [markdown]
# –í—ã—á–∏—Å–ª–∏–º –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –≤–∑—è—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–∏
# –∑–∞–¥–∞–Ω–æ–º –≤ —É—Å–ª–æ–≤–∏–∏ $t$:

# %%
PRECISION_OF_ACCURACY <- 1
t_index <- round(t, PRECISION_OF_ACCURACY) * 10^PRECISION_OF_ACCURACY + 1
t_index

# %% [markdown]
# –ü–æ –¥–∞–Ω–Ω–æ–º—É –∏–Ω–¥–µ–∫—Å—É –∏–º–µ–µ–º –±–ª–∏–∂–∞–π—à–∏–π –≤–µ–∫—Ç–æ—Ä –∑–Ω–∞—á–µ–Ω–∏–π:

# %%
results <- output[t_index, 1:12]
results

# %% [markdown]
# –ü—Ä–∏ $t \rightarrow{} \infty$ (–≤–∑—è–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è $t$
# –≤—ã—à–µ –Ω–µ—Ç —Å–º—ã—Å–ª–∞, —Ç–∞–∫ –∫–∞–∫ –≤–∏–¥–Ω–æ, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è $\forall P_i$ –≤ –∫–æ–Ω—Ü–µ —Ç–∞–±–ª–∏—Ü—ã
# —Å—Ö–æ–¥—è—Ç—Å—è):

# %%
results <- output[nrow(output), 2:12]
results

# %% [markdown]
# –ü–æ–¥—Ç–≤–µ—Ä–¥–∏–º, —á—Ç–æ $\sum P_i = 1$:
# %%
sum(results)

# %%
get_P <- function(P_index) {
    return(as.numeric(results)[1 + P_index])
}

# %% [markdown]
# #### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è
# –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è —Ä–∞–≤–Ω–∞ $P_0$:

# %%
get_P(0)

# %% [markdown]
# #### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
# –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ $P_{\text{–æ—á}}$ —Ä–∞–≤–Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ $P_{\overline{\text{–æ—á}}}$.
# –¢–∞, –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å, —Ä–∞–≤–Ω–∞ —Å—É–º–º–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è–º,
# –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞.
# $$
# P_{\text{–æ—á}} = 1 - P_{\overline{\text{–æ—á}}} = 1 - (P_0 + P_1 + P_{m + 1})
# $$

# %%
1 - (get_P(0) + get_P(1) + get_P(m + 1))

# %% [markdown]
# #### –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
#  –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–∏–º –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
# $$
# \lambda'=\lambda\cdot(1-P_m(t)-P_{2m}(t))
# $$

# %%
absolute_flow_capacity <- lambda * (1 - get_P(m) - get_P(2 * m))
absolute_flow_capacity

# %% [markdown]
# #### –°—Ä–µ–¥–Ω—é—é –¥–ª–∏–Ω—É –æ—á–µ—Ä–µ–¥–∏
# –î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–æ—Å—É–º–º–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
# –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç—Ç–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º –¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–µ–π.
# $$
# L_{\text{–æ—á}} = 1 \cdot P_2(t) + 2 \cdot P_3(t) + 3 \cdot P_4(t) +
# \text{...} + (m-1) \cdot P_m + 1 \cdot P_{m+2}(t) + 2 \cdot P_{m+3}(t) +
# \text{...} + (m - 1) \cdot P_{2m}(t)
# $$

# %%
# –ü–æ–ª—É—á–∞–µ–º –¥–ª–∏–Ω—É –æ—á–µ—Ä–µ–¥–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏.
P.get_queue_length <- function(P_index) {
    if (P_index < 1) {
        return(0)
    }

    if (P_index <= m) {
        return(P_index - 1)
    }

    return(P_index - m - 1)
}

P.get_product <- function(P_index) {
    return(get_P(P_index) * P.get_queue_length(P_index))
}

mean_length <- sum(unlist(
    lapply(c(2:m), P.get_product)
)) + sum(unlist(
    lapply(c((m + 2):(2 * m)), P.get_product)
))
mean_length

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
# $$
# W_{\text{–æ—á}}=\frac{L_{\text{–æ—á}}}{\lambda'}
# $$

# %%
W <- mean_length / absolute_flow_capacity
W

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# –î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–æ—Å—É–º–º–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
# –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç—Ç–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# (–¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–µ–π + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏):
# $$
# L = (1 + 0) \cdot P_1(t) + (1 + 1) \cdot P_2(t) + (1 + 2) \cdot P_3(t) +
# (1 + 3) \cdot P_4(t) + \text{...} + (1 + m - 1) \cdot P_m +
# 1 \cdot P_{m+2}(t) + 2 \cdot P_{m+3}(t) + \text{...} + (m - 1) \cdot P_{2m}(t)
# $$

# %%
# –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏.
P.get_number_of_requests_proccessed <- function(P_index) {
    if (P_index > 0 && P_index <= m) {
        return(1)
    }

    return(0)
}

P.get_product1 <- function(P_index) {
    P.number_of_requests <- P.get_queue_length(P_index) + P.get_number_of_requests_proccessed(P_index)

    return(get_P(P_index) * P.number_of_requests)
}

mean_number_of_requests <- sum(unlist(
    lapply(c(2:m), P.get_product1)
)) + sum(unlist(
    lapply(c((m + 2):(2 * m)), P.get_product1)
))
mean_number_of_requests

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# $$
# T =\frac{L}{\lambda'}
# $$

# %%
T <- mean_number_of_requests / absolute_flow_capacity
T

# %% [markdown]
# ### –ß–∏—Å–ª–µ–Ω–Ω–æ
# –ü–æ—Å—Ç—Ä–æ–∏–º —Å –ø–æ–º–æ—â—å—é –ø–∞–∫–µ—Ç–∞ simmer —Å–∏–º—É–ª—è—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã $M/M/1/m$.


# %%
if (!require("simmer")) {
    install.packages("simmer")
}
library(simmer)
if (!require("simmer.plot")) {
    install.packages("simmer.plot")
}
library(simmer.plot)

MM1m.env <- simmer("SuperDuperSim")
MM1m.env

# %% [markdown]
–ó–∞–¥–∞–¥–∏–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –æ—Ç–∫–∞–∑–∞ –≤ —Å–ª—É—á–∞–µ –ø–æ–ª–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏:

# %%
m.queue <- trajectory("clients' path") %>%
    ## add an intake activity
    seize("server", amount = 1) %>%
    timeout(function() rexp(1, 1 / mu)) %>%
    release("server", amount = 1)

# %% [markdown]
# –î–æ–±–∞–≤–∏–º —Å–∏–º—É–ª—è—Ü–∏—é –ø–æ–ª–æ–º–∫–∏ —Å–∏—Å—Ç–µ–º—ã, –∑–∞–¥–∞–≤ –º–µ—Ö–∞–Ω–∏–∑–º —Å–º–µ–Ω—ã –ø–æ–ª—è $capacity$ —Ä–µ—Å—É—Ä—Å–∞
# $server$ —Å 1 –Ω–∞ 0 –∏ –æ–±—Ä–∞—Ç–Ω–æ —Å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å—é $\gamma$ –∏ $\nu$ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

# %%
# Transform intervals timetable of chronologic points.
# Example:
# 1, 2, 0.5, 0.3, 0.2 -> 1, 3, 3.5, 3.8, 4
accumulate <- function(intervals) {
    timetable <- c()

    for (interval_index in seq_along(intervals)) {
        point <- intervals[interval_index]

        if (interval_index > 1) {
            point <- point + timetable[interval_index - 1]
        }

        timetable <- append(timetable, point)
    }

    return(timetable)
}

# %%
create_timetable <- function(number_of_points, break_intensity, repair_intensity) {
    intervals <- c()

    for (interval_index in 1:number_of_points) {
        intensity <- break_intensity

        if (interval_index %% 2 == 0) {
            intensity <- repair_intensity
        }

        intervals <- append(intervals, rexp(1, 1 / intensity))
    }


    return(accumulate(intervals))
}

create_capacity_schedule <- function(number_of_points) {
    stopifnot(number_of_points %% 2 == 0)

    timetable <- create_timetable(
        number_of_points,
        break_intensity = gamma,
        repair_intensity = nu
    )

    capacity_sequence <- rep(c(1, 0), times = number_of_points / 2)

    period <- sum(timetable)

    return(
        schedule(
            timetable,
            capacity_sequence,
            period
        )
    )
}

capacity_schedule <- create_capacity_schedule(1000)

# %%
SIMULATION_TIME <- FINISH_TIME

MM1m.env %>%
    add_resource(
        "server",
        capacity = capacity_schedule,
        queue_size = m
    ) %>%
    add_generator("clients", m.queue, function() rexp(1, lambda)) %>%
    run(until = SIMULATION_TIME)

# %%
arrivals <- get_mon_arrivals(MM1m.env)
arrivals

# %% [markdown]
# –õ–æ–≥–∏ —Å–∏–º—É–ª—è—Ü–∏–∏:

# %%
resources <- get_mon_resources(MM1m.env)
resources

# %% [markdown]
# #### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è
# –ü–æ–¥—Å—á–∏—Ç–∞–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞,
# –∫ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ—Å—Ç–æ—è–Ω–∏–π.

# %%
free_states <- resources %>% subset(server == 0) %>% subset( capacity > 0)
free_states

# %%
nrow(free_states) / nrow(resources)

# %% [markdown]
# #### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
# –í—ã—á–∏—Å–ª–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏, –ø–æ–¥—Å—á–∏—Ç–∞–≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π,
# –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ—á–µ—Ä–µ–¥—å –Ω–µ –ø—É—Å—Ç–∞, –∫ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø–∏—Å–µ–π.

# %%
queue_unempty <- resources %>% subset(queue != 0)
queue_unempty

# %%
nrow(queue_unempty) / nrow(resources)

# %% [markdown]
# #### –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
#  –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–∏–º –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
# $$
# \lambda'=\lambda\cdot(1-P_m(t)-P_{2m}(t))
# $$

# %%
number_of_unfinished <- arrivals %>% with(sum(!finished))
number_of_unfinished

# %%
finish_probability <- number_of_unfinished / nrow(arrivals)
finish_probability

# %%
absolute_flow_capacity <- lambda * finish_probability
absolute_flow_capacity

# %% [markdown]
# #### –°—Ä–µ–¥–Ω—é—é –¥–ª–∏–Ω—É –æ—á–µ—Ä–µ–¥–∏

# %%
mean_length <- resources %>% with(mean(queue))
mean_length

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
# –ü–æ—Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ –∏ —Å—Ä–∞–≤–Ω–∏–º –µ–≥–æ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º $W_\text{–æ—á}$ (—á–µ—Ä–Ω–∞—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä—è–º–∞—è), –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏:

# %%
plot(arrivals, metric = "waiting_time", names = "server", items = "system") +
    coord_cartesian(xlim = c(0, SIMULATION_TIME), ylim = c(0, 100)) +
    geom_hline(yintercept = W)


# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ —Å—Ä–∞–≤–Ω–∏–º —Å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–º, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—è –≥—Ä–∞—Ñ–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
# —Ä–µ—Å—É—Ä—Å–∞ `server`:

# %%
plot(resources, metric = "usage", names = "server", items = "system") +
    geom_hline(yintercept = mean_number_of_requests)

# %% [markdown]
# –ü–æ —ç—Ç–æ–º—É –≥—Ä–∞—Ñ–∏–∫—É —Å–ª–æ–∂–Ω–æ —Å—É–¥–∏—Ç—å, –ø–æ—ç—Ç–æ–º—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ,
# –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Å—å —Ç–∞–±–ª–∏—Ü–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:

# %%
resources %>% with(mean(queue) + mean(server))

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ $T$
# –ü–æ—Å—Ç—É–ø–∏–º —Å–æ —Å—Ä–µ–¥–Ω–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ $T$ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏
# —Å $W$ - —Å—Ä–∞–≤–Ω–∏–º –¥–≤–∞ –≥—Ä–∞—Ñ–∏–∫–∞:

# %%
plot(arrivals, metric = "flow_time", names = "server", items = "system") +
    coord_cartesian(xlim = c(0, 80000), ylim = c(0, 100)) +
    geom_hline(yintercept = T)

# %% [markdown]
# ### –í—ã–≤–æ–¥—ã
# –ö–∞–∫ –≤–∏–¥–Ω–æ, —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—é—Ç
# —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —á–∏—Å–ª–µ–Ω–Ω—ã–º –º–µ—Ç–æ–¥–æ–º. –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
# —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ ùëÅ —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.
