# %% [markdown]
# # –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6. –ú–µ—Ç–æ–¥ –∫–≤–∞–∑–∏—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ–≥–æ —É–∫—Ä—É–ø–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–Ω–æ–≥–æ–º–µ—Ä–Ω—ã—Ö –º–∞—Ä–∫–æ–≤—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è-–≥–∏–±–µ–ª–∏
# ## –ó–∞–¥–∞–Ω–∏–µ 1

# $K$ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ $M$ —Å–µ—Ä–≤–µ—Ä–æ–≤,
# –ø—Ä–∏ —ç—Ç–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç —Å—Ä–∞–∑—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä,
# –∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ $N$ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤,
# –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∏—Ä—É—Å–æ–≤.
# –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤ $\lambda$,
# –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤-–∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤ $\nu$,
# –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ $\mu$,
# –ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å –≤–∏—Ä—É—Å–æ–º —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é $p$.
# –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å –≤–∏—Ä—É—Å–æ–º, –æ–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–∫–∞–∑ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö
# —Å–µ—Ä–≤–µ—Ä–∞—Ö. –î–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤–∏—Ä—É—Å–æ–≤ –∏–º–µ–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ
# –æ—á–µ—Ä–µ–¥–∏ $m_1$ , –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ –æ—á–µ—Ä–µ–¥–∏ $m_2$.

# - –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å–∏—Å—Ç–µ–º—ã, —É—á–∏—Ç—ã–≤–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤,
# –∫–æ—Ç–æ—Ä—ã–µ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö-–∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞—Ö,
# –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö;
# - –ù–∞–ø–∏—Å–∞—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞ –¥–ª—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π —Å–æ—Å—Ç–æ—è–Ω–∏–π, —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö
# –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π;
# - –¢—Ä–µ–º—è —Å–ø–æ—Å–æ–±–∞–º–∏ (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ, –º–µ—Ç–æ–¥–æ–º —É–∫—Ä—É–ø–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π, –ø–æ
# —É—Ä–∞–≤–Ω–µ–Ω–∏—è–º –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞) –Ω–∞–π—Ç–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –°–ú–û:
#   - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ,
#   - –∞–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å,
#   - —Å—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ.

# %%
Variant <- 5
set.seed(Variant)
K <- sample(c(3:6), 1)
M <- sample(c(1:3), 1)
N <- sample(c(1:3), 1)
lambda <- runif(1)
mu <- runif(1)
nu <- runif(1)
p <- runif(1)
m2 <- sample(c(0:2), 1)
m1 <- sample(c(0:2), 1)
View(data.frame(K, M, N, lambda, mu, nu, p, m1, m2))

# %% [markdown]
# –í–≤–µ–¥–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
# - $S_{4000}$ - –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã
# —Å–≤–æ–±–æ–¥–Ω—ã;
# - $S_{3010}$ - —Ç—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# –≤–∏—Ä—É—Å;
# - $S_{3001}$ - —Ç—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
# –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{2110}$ - –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# –≤–∏—Ä—É—Å, –æ–¥–Ω–∞ —Å—Ç–æ–∏—Ç –≤ –æ—á–µ—Ä–µ–¥–∏;
# - $S_{2011}$ - –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# –≤–∏—Ä—É—Å, –æ–¥–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{2002}$ - –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø–∏—à—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –¥–≤–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{1111}$ - –æ–¥–∏–Ω –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –ø–∏—à–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å—Ç–æ–∏—Ç
# –≤ –æ—á–µ—Ä–µ–¥–∏, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –≤–∏—Ä—É—Å, –¥–≤–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{1003}$ - –æ–¥–∏–Ω –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –ø–∏—à–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, —Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞
# - $S_{1012}$ - –æ–¥–∏–Ω –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –ø–∏—à–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
# –Ω–∞ –≤–∏—Ä—É—Å, –¥–≤–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{1003}$ - –æ–¥–∏–Ω –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –ø–∏—à–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É, —Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞
# —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{0112}$ - –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –æ–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å—Ç–æ–∏—Ç
# –≤ –æ—á–µ—Ä–µ–¥–∏, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
# –Ω–∞ –≤–∏—Ä—É—Å, –¥–≤–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;
# - $S_{0013}$ - –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –æ–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞, –æ–¥–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞
# –≤–∏—Ä—É—Å, —Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ;


# %% [markdown]
# –¢–æ–≥–¥–∞ –≥—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å:
# ![graph](./State_graph.png)

# %% [markdown]
# ### –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –ø–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è–º –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞

# %% [markdown]
# –ü–æ –≥—Ä–∞—Ñ—É —Å–æ—Å—Ç–∞–≤–∏–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è –ö–æ–ª–º–æ–≥–æ—Ä–æ–≤–∞:
# $$
# \begin{cases}
# \frac{dP_{4000}(t)}{dt} = -4 \lambda P_{4000}(t) + p \nu P_{3010}(t) + \mu P_{3001}(t) \\
# \frac{dP_{3010}(t)}{dt} = -(3 \lambda + p\nu + (1-p)\nu) P_{3010}(t) + 4 \lambda P_{4000}(t) + p \nu P_{2110}(t) + \mu P_{2011}(t) \\
# \frac{dP_{2110}(t)}{dt} = -(p\nu + (1-p)\nu) P_{2110}(t) + 3 \lambda P_{3010}(t) + \mu P_{1111} \\
# \frac{dP_{3001}(t)}{dt} = -(3 \lambda + \mu) P_{3001}(t) + p \nu P_{2011} + 2 \mu P_{2002} + (1-p) \nu P_{3010}(t) \\
# \frac{dP_{2011}(t)}{dt} = -(2 \lambda + p\nu + (1-p)\nu + \mu) P_{2011}(t) + 3 \lambda P_{3001}(t) + p \nu P_{1111}(t) + 2 \mu P_{1012}(t) + (1-p)\nu P_{2110}(t) \\
# \frac{dP_{1111}(t)}{dt} = -(p\nu + (1-p)\nu + \mu) P_{1111}(t) + 2 \lambda P_{2011}(t) + 2 \mu P_{0112} \\
# \frac{dP_{2002}(t)}{dt} = -(2 \lambda + 2 \mu) P_{2002}(t) + p \nu P_{1012} + 3 \mu P_{1003} + (1-p) \nu P_{2011}(t) \\
# \frac{dP_{1012}(t)}{dt} = -(\lambda + p\nu + (1-p)\nu + 2 \mu) P_{1012}(t) + 2 \lambda P_{2002}(t) + p \nu P_{0112}(t) + 3 \mu P_{0013}(t) + (1-p)\nu P_{1111}(t) \\
# \frac{dP_{0112}(t)}{dt} = -(p\nu + (1-p)\nu + 2 \mu) P_{0112}(t) + \lambda P_{1012}(t) \\
# \frac{dP_{1003}(t)}{dt} = -(\lambda + 3 \mu) P_{1003}(t) + p\nu P_{0013}(t) + (1-p)\nu P_{1012}(t) \\
# \frac{dP_{0013}(t)}{dt} = -(p\nu + 3 \mu) P_{0013}(t) + \lambda P_{1003}(t) + (1-p)\nu P_{0112}(t)
# \end{cases}
# $$

# –∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏:
# $$
# P_{4000}(t) + P_{3010}(t) + P_{2110}(t) + P_{3001}(t) + P_{2011}(t) + P_{1111}(t) + P_{2002}(t) + P_{1012}(t) + P_{0112}(t) + P_{1003}(t) + P_{0013}(t) = 1
# $$

# %% [markdown]
# –†–µ—à–∏–º —ç—Ç–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –ø–∞–∫–µ—Ç–∞ deSolve
# (—Å–º. 75 —Å—Ç—Ä. [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](chrome-extension://gfbliohnnapiefjpjlpjnehglfpaknnc/pages/pdf_viewer.html?r=https://cran.r-project.org/web/packages/deSolve/deSolve.pdf)):

# %%
if (!require("deSolve")) {
    install.packages("deSolve")
}
library(deSolve)

ode_system_equations <- function(Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        dP_4000 <- -4 * lambda * abs(P_4000) + p * nu * abs(P_3010) + mu * abs(P_3001)
        dP_3010 <- -(3 * lambda + p * nu + (1-p) * nu) * abs(P_3010) + 4 * lambda * abs(P_4000) + p * nu * abs(P_2110) + mu * abs(P_2011)
        dP_2110 <- -(p * nu + (1-p) * nu) * abs(P_2110) + 3 * lambda * abs(P_3010) + mu * abs(P_1111)
        dP_3001 <- -(3 * lambda + mu) * abs(P_3001) + p * nu * abs(P_2011) + 2 * mu * abs(P_2002) + (1-p) * nu * abs(P_3010)
        dP_2011 <- -(2 * lambda + p* nu + (1-p) * nu + mu) * abs(P_2011) + 3 * lambda * abs(P_3001) + p * nu * abs(P_1111) + 2 * mu * abs(P_1012) + (1-p) * nu * abs(P_2110)
        dP_1111 <- -(p * nu + (1-p) * nu + mu) * abs(P_1111) + 2 * lambda * abs(P_2011) + 2 * mu * abs(P_0112)
        dP_2002 <- -(2 * lambda + 2 * mu) * abs(P_2002) + p * nu * abs(P_1012) + 3 * mu * abs(P_1003) + (1-p) * nu * abs(P_2011)
        dP_1012 <- -(lambda + p * nu + (1-p) * nu + 2 * mu) * abs(P_1012) + 2 * lambda * abs(P_2002) + p * nu * abs(P_0112) + 3 * mu * abs(P_0013) + (1-p) * nu * abs(P_1111)
        dP_0112 <- -(p * nu + (1-p) * nu + 2 * mu) * abs(P_0112) + lambda * abs(P_1012)
        dP_1003 <- -(lambda + 3 * mu) * abs(P_1003) + p * nu * abs(P_0013) + (1-p) * nu * abs(P_1012)
        dP_0013 <- -(p * nu + 3 * mu) * abs(P_0013) + lambda * abs(P_1003) + (1-p) * nu * abs(P_0112)

        # Specifying list of derivatives.
        return(
            list(c(
                dP_4000,
                dP_3010,
                dP_2110,
                dP_3001,
                dP_2011,
                dP_1111,
                dP_2002,
                dP_1012,
                dP_0112,
                dP_1003,
                dP_0013
            ))
        )
    })
}

# %%
pars <- NULL
yini <- c(
    P_4000 = 1,
    P_3010 = 0,
    P_2110 = 0,
    P_3001 = 0,
    P_2011 = 0,
    P_1111 = 0,
    P_2002 = 0,
    P_1012 = 0,
    P_0112 = 0,
    P_1003 = 0,
    P_0013 = 0
)


INITIAL_TIME <- 0
FINISH_TIME <- 10000

ACCURACY <- 0.1
times <- seq(INITIAL_TIME, FINISH_TIME, by = ACCURACY)
output <- ode(yini, times, ode_system_equations, pars)
output

# %% [markdown]
# –ü—Ä–∏ $t \rightarrow{} \infty$ (–≤–∑—è–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è $t$
# –≤—ã—à–µ –Ω–µ—Ç —Å–º—ã—Å–ª–∞, —Ç–∞–∫ –∫–∞–∫ –≤–∏–¥–Ω–æ, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è $\forall P_i$ –≤ –∫–æ–Ω—Ü–µ —Ç–∞–±–ª–∏—Ü—ã
# —Å—Ö–æ–¥—è—Ç—Å—è):

# %%
results <- output[nrow(output), 2:12]
results

# %% [markdown]
# –ü–æ–¥—Ç–≤–µ—Ä–¥–∏–º, —á—Ç–æ $\sum P_i = 1$:
# %%
sum(results)

# %% [markdown]
–°–æ–∑–¥–∞–¥–∏–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.

# %%
if (!require("hash")) {
    install.packages("hash")
}
library(hash)
probabilities <- hash(results)

# %%
P <- function(P_index) {
    hash_index <- paste("P_", P_index, sep = "")

    try(
        if (!has.key(hash_index, probabilities)) {
            stop("No P value with index: ", P_index)
        }
    )

    return(probabilities[[hash_index]])
}

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# –î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ —á–∏—Å–ª–∞ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ –ø—Ä–æ—Å—É–º–º–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
# –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç—Ç–∏–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# (–¥–ª–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–∏ + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞ + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
# –∑–∞—è–≤–æ–∫ –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏):
# $$
# L = 0 \cdot P_{4000}(t) + 1 \cdot P_{3010}(t) + (1 + 1) \cdot P_{2110}(t) +
# 1 \cdot P_{3001}(t) + (1 + 1) \cdot P_{2011}(t) + (1 + 1 + 1) \cdot P_{1111}(t) +
# 2 \cdot P_{2002}(t) + (1 + 2) \cdot P_{1012}(t) + (1 + 1 + 2) \cdot P_{0112}(t) +
# 3 \cdot P_{1003}(t) + (1 + 3) \cdot P_{0013}(t)
# $$

–£–ø—Ä–æ—Å—Ç–∏–≤, –ø–æ–ª—É—á–∞–µ–º:
# $$
# L = P_{3010}(t) + 2 \cdot P_{2110}(t) +
# P_{3001}(t) + 2 \cdot P_{2011}(t) + 3 \cdot P_{1111}(t) +
# 2 \cdot P_{2002}(t) + 3 \cdot P_{1012}(t) + 4 \cdot P_{0112}(t) +
# 3 \cdot P_{1003}(t) + 4 \cdot P_{0013}(t)
# $$

# %%
mean_number_of_requests <- P("3010") + 2 * P("2110") + P("3001") + 2 * P("2011") +
    3 * P("1111") + 2 * P("2002") + 3 * P("1012") + 4 * P("0112") + 3 * P("1003") +
    4 * P("0013")
mean_number_of_requests

# %% [markdown]
# #### –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
# –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–±—Å–æ–ª—é—Ç–Ω–æ–π –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —É—á—Ç–µ–º, —á—Ç–æ
# –∑–∞—è–≤–∫–∏-–ø—Ä–æ–≥—Ä–∞–º–º—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω –≤–∏—Ä—É—Å –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–ª–Ω–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
# (–æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è), —Ç.–µ. –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –ø–æ–ª—É—á–∏–≤—à–∏—Ö –ø–æ–ª–Ω–æ–µ
# –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –≤ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏. –î–ª—è –∑–∞–º–∫–Ω—É—Ç—ã—Ö —Å–∏—Å—Ç–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è
# —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—ã—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫
# $$
# \lambda'=P_{\text{–∑–∞–Ω}}\cdot \mu
# $$

# %%
absolute_flow_capacity <- mu * (
    3 * (P("1003") + P("0013")) +
    2 * (P("2002") + P("1012") + P("0112")) +
    P("3001") + P("2011") + P("1111")
)
absolute_flow_capacity


# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ
# $$
# T =\frac{L}{\lambda'}
# $$

# %%
T <- mean_number_of_requests / absolute_flow_capacity
T

# %% [markdown]
# ### –ß–∏—Å–ª–µ–Ω–Ω–æ
# –ü–æ—Å—Ç—Ä–æ–∏–º —Å –ø–æ–º–æ—â—å—é –ø–∞–∫–µ—Ç–∞ simmer —Å–∏–º—É–ª—è—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã.


# %%
if (!require("simmer")) {
    install.packages("simmer")
}
library(simmer)
if (!require("simmer.plot")) {
    install.packages("simmer.plot")
}
library(simmer.plot)

env <- simmer("SuperDuperSim")
env

# %% [markdown]
–ó–∞–¥–∞–¥–∏–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –æ—Ç–∫–∞–∑–∞ –≤ —Å–ª—É—á–∞–µ –ø–æ–ª–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏:

# %%
queue <- trajectory("program's path") %>%
    # set_attribute("number_of_free_programmers", function() get_global(env, "number_of_free_programmers") - 1) %>%
    set_source("program", function() rexp(1, 1 / lambda )) %>%
    seize("antivirus_server", amount = 1) %>%
    timeout(function() rexp(1, 1 / nu)) %>%
    log_(function() {
        seized <- get_seized(env, resources = c('antivirus_server', 'server'))

        return(paste0(seized[1], seized[2]))
    }) %>%
    release("antivirus_server", amount = 1) %>%
    leave(
          function() runif(1) < p,
          out = trajectory() %>% log_("Antivirus found")
    ) %>%
    log_("No antivirus found") %>%
    seize("server", amount = 1) %>%
    timeout(function() rexp(1, 1 / mu)) %>%
    release("server", amount = 1)

# %%
SIMULATION_TIME <- FINISH_TIME

env %>%
    add_resource(
        "antivirus_server",
        capacity = N,
        queue_size = m1
    ) %>%
    add_resource(
        "server",
        capacity = M,
        queue_size = m2
    ) %>%
    add_generator("program", queue, function() rexp(1, 1 / (K * lambda))) %>%
    run(until = SIMULATION_TIME)

# %%
arrivals <- get_mon_arrivals(env)
arrivals

# %% [markdown]
# –õ–æ–≥–∏ —Å–∏–º—É–ª—è—Ü–∏–∏:

# %%
resources <- get_mon_resources(env)
resources

# %% [markdown]
# #### –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
# –ê–±—Å–æ–ª—é—Ç–Ω—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–º —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
# %%
number_of_unfinished <- arrivals %>% with(sum(!finished))
number_of_unfinished

# %%
finish_probability <- number_of_unfinished / nrow(arrivals)
finish_probability

# %%
absolute_flow_capacity <- lambda * finish_probability
absolute_flow_capacity

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# –†–∞—Å—Å—á–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Å—å —Ç–∞–±–ª–∏—Ü–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:

# %%
mean_number_of_requests <- resources %>% with(
    mean(queue) + mean(server) + mean(system)
)
mean_number_of_requests

# %% [markdown]
# #### –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ
# –ù–∞–π–¥–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤–µ–ª–∏—á–∏–Ω —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫
# –≤ —Å–∏—Å—Ç–µ–º–µ

# %%
T <- mean_number_of_requests / absolute_flow_capacity
T

# %% [markdown]
# ## –í—ã–≤–æ–¥
# –ö–∞–∫ –≤–∏–¥–Ω–æ, —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞–µ—Ç
# —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
# —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ ùëÅ —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.

# %% [markdown]
# ### –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –º–µ—Ç–æ–¥–æ–º —É–∫—Ä—É–ø–Ω–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
# –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ —á–∞—Å—Ç—è–º, —Å –ø–æ–º–æ—â—å—é —É–∫—Ä—É–ø–Ω–µ–Ω–Ω—ã—Ö (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö) –º–æ–¥–µ–ª–µ–π.
# –í –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –Ω–µ–∫–æ—Ç–æ—Ä—É—é —á–∞—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã, –∞ –≤–ª–∏—è–Ω–∏–µ
# –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —á–∞—Å—Ç–µ–π –æ—Ç—Ä–∞–∑–∏–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–º –æ–±–æ–±—â–µ–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º (–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º —Å–≤—è–∑–∏).

# –ü—Ä–µ–¥–ª–æ–∂–∏–º –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é –Ω–∞—à–µ–π –∑–∞–¥–∞—á–∏ –≤ –≤–∏–¥–µ –¥–≤—É—Ö –º–æ–¥–µ–ª–µ–π.

# –í –ø–µ—Ä–≤–æ–π –º–æ–¥–µ–ª–∏ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞–ª–∏—á–∏—è
# –≤–∏—Ä—É—Å–æ–≤ –∑–∞–º–µ–Ω–∏–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º –æ–±–æ–±—â–µ–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º - –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å—é
# –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –æ–±—â $\mu_{\text{–æ–±—â}}$.

# ![Programmers graph](./Programmers_graph.png)

# –ö–∞–∫ –≤–∏–¥–Ω–æ, –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –æ–±—ã—á–Ω–æ–π –º–æ–¥–µ–ª—å—é
# —Ä–æ–∂–¥–µ–Ω–∏—è –≥–∏–±–µ–ª–∏ –¥–ª—è –∑–∞–º–∫–Ω—É—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã

# %% [markdown]
# $$
# P_0 = \left(1 + \frac{K\lambda}{\mu_{\text{–æ–±—â}}} + \frac{K(K-1)\lambda^2}{\mu_{\text{–æ–±—â}}^2} + \ldots + \frac{K!\lambda^K}{\mu_{\text{–æ–±—â}}^K}\right)^{-1}
# $$

# %% [markdown]
# –ü—É—Å—Ç—å $\mu_{\text{–æ–±—â}} = \frac{\lambda'}{2}$. –¢–æ–≥–¥–∞:

# %%
mu_ <- 0.1
y_ <- lambda / mu_
y_

# %%

P0 <- (1 +
    K * y_ +
    K * (K-1) * y_^2 +
    K * (K-1) * (K-2) * y_^3 +
    K * (K-1) * (K-2) * (K-3) * y_^K
)^(-1)
P0

# %% [markdown]
# $$
# P_1 = P_0 \frac{K\lambda}{\mu_{\text{–æ–±—â}}}
# $$

# %%
P1 <- P0 * K * y_
P1

# %% [markdown]
# $$
# P_2 = P_0 \frac{K\lambda^2}{\mu_{\text{–æ–±—â}}^2}
# $$

# %%
P2 <- P1 * (K - 1) *  y_
P2

# %% [markdown]
# $$
# P_3 = P_0\frac{K\lambda^3}{\mu_{\text{–æ–±—â}}^3}
# $$

# %%
P3 <- P2 * (K - 2) * y_
P3

# %% [markdown]
# $$
# P_K = P_0\frac{K\lambda^K}{\mu_{\text{–æ–±—â}}^K}
# $$

# %%
P4 <- P3 * (K - 3) * y_
P4

# %%
P0 + P1 + P2 + P3 + P4

# %% [markdown]
# $$
# L_{\text{—Å–∏—Å—Ç}} = \sum_{k=1}^K k \cdot P_k
# $$

# %% [markdown]
# $$
# T_{\text{—Å–∏—Å—Ç}} = \frac{L_{\text{—Å–∏—Å—Ç}}}{\lambda(4-L_{\text{—Å–∏—Å—Ç}})}
# $$

# %% [markdown]
# –í–æ –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏ –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ –≤ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ü–∏—Ä–∫—É–ª–∏—Ä—É—é—Ç
# $L_{\text{—Å–∏—Å—Ç}}$ –∑–∞—è–≤–æ–∫. –í –∫–∞—á–µ—Å—Ç–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å–∏—Å—Ç–µ–º—ã –≤–æ–∑—å–º–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
# –∑–∞—è–≤–æ–∫, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö:
# $$
# S_0, S_1, S_2, \ldots, S_{L_{\text{—Å–∏—Å—Ç}}}
# $$

# %% [markdown]
# ![Servers graph](./Servers_graph.png)

# %% [markdown]
# $$
# \nu_n = (1-p)\nu \cdot \min{(N,L_{\text{—Å–∏—Å—Ç}}-n)}, n=0, \ldots, L_{\text{—Å–∏—Å—Ç}} - 1 \\
# \mu_n = \mu \cdot \min{(M, n)}, n=1, 2, \ldots, L_{\text{—Å–∏—Å—Ç}}
# $$

# %% [markdown]
# –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –ø–æ—Å—á–∏—Ç–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏:
# $$
# \pi_0 = \left(1+\frac{\nu_0}{\mu_1}+\frac{\nu_0\nu_1}{\mu_1\mu_2}+\ldots\right)^{-1} \\
# \pi_1=\pi_0\cdot \frac{\nu_0}{\mu_1} \\
# \pi_2=\pi_0\cdot \frac{\nu_0\nu_1}{\mu_1\mu_2} \\
# $$

# %% [markdown]
# –¢–æ–≥–¥–∞:
# $$
# \mu_{\text{–æ–±—â}}=\sum_{n=1}^{L_{\text{—Å–∏—Å—Ç}}}\pi_n\cdot \mu_n\tag{11}
# $$

# %% [markdown]
# ### –í—ã–≤–æ–¥—ã
# –ö–∞–∫ –≤–∏–¥–Ω–æ, —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—é—Ç
# —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —á–∏—Å–ª–µ–Ω–Ω—ã–º –º–µ—Ç–æ–¥–æ–º. –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
# —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ ùëÅ —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.
